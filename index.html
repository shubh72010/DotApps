<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 3 Pro - AI App Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .preview-frame { background: white; width: 100%; height: 100%; border: none; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- TEMPLATES ---
        const TEMPLATES = {
            "blank": { name: "Blank App", pages: [{ name: "Home", content: "<h1>Welcome</h1><p>Start building...</p>" }] },
            "commerce": { name: "E-Commerce", pages: [
                { name: "Home", content: "<header class='p-4 bg-blue-600 text-white'><h1>Shop</h1></header><div class='p-4 grid gap-4'>Product Grid...</div>" },
                { name: "Cart", content: "<div class='p-4'><h2>Your Cart</h2><button class='bg-green-500 text-white p-2 rounded'>Checkout</button></div>" }
            ]},
            "landing": { name: "Landing Page", pages: [{ name: "Home", content: "<div class='h-screen flex items-center justify-center bg-gray-100'><h1>Big Idea</h1></div>" }] }
        };

        // --- MAIN APP COMPONENT ---
        function AppBuilder() {
            // State
            const [config, setConfig] = useState({
                appName: "MyGeminiApp",
                packageName: "com.gemini.generated",
                themeColor: "#3b82f6",
                template: "blank",
                openRouterKey: "",
                modelName: "xiaomi/mimo-v2-flash:free",
                pages: TEMPLATES["blank"].pages
            });
            const [activeTab, setActiveTab] = useState("editor"); // editor, code, settings
            const [buildLogs, setBuildLogs] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            const [previewUrl, setPreviewUrl] = useState("");
            const iframeRef = useRef(null);

            // --- AI GENERATION LOGIC ---
            const generateWithAI = async (promptType, context) => {
                if (!config.openRouterKey) {
                    alert("Please enter your OpenRouter API Key in Settings first.");
                    setActiveTab("settings");
                    return;
                }
                setIsGenerating(true);
                log("AI", `Requesting ${promptType} from ${config.modelName}...`);

                const prompts = {
                    "suggest_ui": `You are a UI generator. Return ONLY raw HTML (using Tailwind classes) for a mobile app page about: ${context}. No markdown, no explanations.`,
                    "logic": `You are a React developer. Write a JavaScript function logic for: ${context}. Return code only.`
                };

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${config.openRouterKey}`,
                            "HTTP-Referer": window.location.href,
                            "X-Title": "GeminiAppBuilder",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            "model": config.modelName,
                            "messages": [
                                { "role": "system", "content": "You are a coding assistant. Output only code. No markdown formatting." },
                                { "role": "user", "content": prompts[promptType] || context }
                            ]
                        })
                    });
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content || "Error generating.";
                    log("AI", "Generation complete.");
                    return content.replace(/```html/g, '').replace(/```/g, ''); // Cleanup
                } catch (e) {
                    log("Error", e.message);
                    return "";
                } finally {
                    setIsGenerating(false);
                }
            };

            // --- PREVIEW GENERATION ---
            useEffect(() => {
                updatePreview();
            }, [config]);

            const updatePreview = () => {
                const currentPage = config.pages[0]; // Simple single page preview for now
                const html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <style>
                            body { font-family: system-ui, -apple-system, sans-serif; }
                            :root { --primary: ${config.themeColor}; }
                        </style>
                    </head>
                    <body class="bg-gray-50">
                        ${currentPage.content}
                        </body>
                    </html>
                `;
                setPreviewUrl(html);
            };

            // --- ZIP DOWNLOADER (Build Pipeline Simulation) ---
            const downloadProject = async () => {
                log("Build", "Initializing Build Pipeline...");
                const zip = new JSZip();
                
                // 1. Root Files
                zip.file("package.json", JSON.stringify({
                    name: config.appName.toLowerCase().replace(/\s+/g, '-'),
                    version: "1.0.0",
                    scripts: { "dev": "vite", "build": "vite build", "cap": "cap sync" },
                    dependencies: { "react": "^18.2.0", "react-dom": "^18.2.0", "@capacitor/core": "^5.0.0", "@capacitor/android": "^5.0.0" },
                    devDependencies: { "@vitejs/plugin-react": "^4.0.0", "vite": "^4.3.0", "@capacitor/cli": "^5.0.0" }
                }, null, 2));
                
                zip.file("vite.config.js", `import { defineConfig } from 'vite'; import react from '@vitejs/plugin-react'; export default defineConfig({ plugins: [react()] });`);
                zip.file("capacitor.config.json", JSON.stringify({
                    appId: config.packageName,
                    appName: config.appName,
                    webDir: "dist",
                    bundledWebRuntime: false
                }, null, 2));

                // 2. Source Code
                const src = zip.folder("src");
                src.file("main.jsx", `import React from 'react'; import ReactDOM from 'react-dom/client'; import App from './App'; import './index.css'; ReactDOM.createRoot(document.getElementById('root')).render(<React.StrictMode><App /></React.StrictMode>);`);
                src.file("index.css", `@tailwind base; @tailwind components; @tailwind utilities;`);
                
                // Generate App.jsx based on pages
                const appJsx = `
import React, { useState } from 'react';

export default function App() {
  const [page, setPage] = useState('${config.pages[0].name}');

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900">
      {/* Navigation */}
      <nav style={{backgroundColor: '${config.themeColor}'}} className="text-white p-4 shadow-md flex justify-between items-center">
        <h1 className="text-xl font-bold">${config.appName}</h1>
      </nav>

      {/* Main Content */}
      <main className="p-4">
        ${config.pages.map(p => `
          {page === '${p.name}' && (
            <div>
              {/* Generated Content */}
              <div dangerouslySetInnerHTML={{__html: \`${p.content.replace(/`/g, '\\`')}\`}} />
            </div>
          )}
        `).join('\n')}
      </main>
    </div>
  );
}
                `;
                src.file("App.jsx", appJsx);

                // 3. Android instructions
                zip.file("README.md", `# ${config.appName}\n\n## Build Steps\n1. \`npm install\`\n2. \`npm run build\`\n3. \`npx cap add android\`\n4. \`npx cap sync\`\n5. \`npx cap open android\``);

                log("Build", "Compressing archive...");
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${config.appName}-project.zip`);
                log("Build", "Download started. Project ready for Android Studio.");
            };

            // --- LOGGING HELPER ---
            const log = (source, msg) => {
                const time = new Date().toLocaleTimeString();
                setBuildLogs(prev => [`[${time}] [${source}] ${msg}`, ...prev]);
            };

            // --- HANDLERS ---
            const handlePageEdit = (index, newContent) => {
                const newPages = [...config.pages];
                newPages[index].content = newContent;
                setConfig({ ...config, pages: newPages });
            };

            const handleAIGen = async (index) => {
                const prompt = prompt("Describe the UI you want (e.g., 'A login form with email and password fields'):");
                if (!prompt) return;
                const generatedHtml = await generateWithAI("suggest_ui", prompt);
                if (generatedHtml) handlePageEdit(index, generatedHtml);
            };

            return (
                <div className="flex h-screen w-full overflow-hidden">
                    {/* SIDEBAR */}
                    <div className="w-80 glass flex flex-col border-r border-gray-700">
                        <div className="p-4 border-b border-gray-700">
                            <h1 className="text-xl font-bold text-blue-400"><i className="fa-solid fa-microchip mr-2"></i>Gemini Builder</h1>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            {/* Tabs */}
                            <div className="flex space-x-2 bg-gray-800 p-1 rounded-lg">
                                {['editor', 'settings'].map(t => (
                                    <button key={t} 
                                        onClick={() => setActiveTab(t)} 
                                        className={`flex-1 py-1 px-2 rounded-md capitalize text-sm ${activeTab === t ? 'bg-blue-600 text-white' : 'text-gray-400 hover:text-white'}`}
                                    >{t}</button>
                                ))}
                            </div>

                            {activeTab === 'editor' && (
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-gray-400 uppercase">App Name</label>
                                        <input type="text" value={config.appName} onChange={e => setConfig({...config, appName: e.target.value})} className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm mt-1 focus:border-blue-500 outline-none" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 uppercase">Theme Color</label>
                                        <div className="flex items-center gap-2 mt-1">
                                            <input type="color" value={config.themeColor} onChange={e => setConfig({...config, themeColor: e.target.value})} className="bg-transparent border-none w-8 h-8" />
                                            <span className="text-sm font-mono">{config.themeColor}</span>
                                        </div>
                                    </div>
                                    
                                    <div className="border-t border-gray-700 pt-4">
                                        <label className="text-xs text-gray-400 uppercase flex justify-between">
                                            <span>Pages</span>
                                            <button className="text-blue-400 hover:text-blue-300" onClick={() => setConfig({...config, pages: [...config.pages, {name: 'New Page', content: '<div>New Content</div>'}]})}>+ Add</button>
                                        </label>
                                        {config.pages.map((page, idx) => (
                                            <div key={idx} className="mt-2 bg-gray-800 rounded p-2 border border-gray-700">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-bold text-sm">{page.name}</span>
                                                    <button onClick={() => handleAIGen(idx)} disabled={isGenerating} className="text-xs bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded">
                                                        {isGenerating ? <i className="fa-solid fa-spinner fa-spin"></i> : <i className="fa-solid fa-wand-magic-sparkles"></i>} AI Gen
                                                    </button>
                                                </div>
                                                <textarea 
                                                    value={page.content} 
                                                    onChange={(e) => handlePageEdit(idx, e.target.value)}
                                                    className="w-full h-24 bg-gray-900 text-gray-300 text-xs font-mono p-2 rounded border border-gray-700"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'settings' && (
                                <div className="space-y-4">
                                    <div className="p-3 bg-yellow-900/30 border border-yellow-700 rounded">
                                        <p className="text-xs text-yellow-200">API Key is stored only in browser memory.</p>
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 uppercase">OpenRouter API Key</label>
                                        <input type="password" value={config.openRouterKey} onChange={e => setConfig({...config, openRouterKey: e.target.value})} className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm mt-1" placeholder="sk-or-v1-..." />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 uppercase">Model</label>
                                        <input type="text" value={config.modelName} onChange={e => setConfig({...config, modelName: e.target.value})} className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm mt-1" />
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* BUILD ACTIONS */}
                        <div className="p-4 border-t border-gray-700 bg-gray-900">
                            <button onClick={downloadProject} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded shadow-lg transition flex items-center justify-center gap-2">
                                <i className="fa-brands fa-android"></i> Download Project Zip
                            </button>
                        </div>
                    </div>

                    {/* PREVIEW AREA */}
                    <div className="flex-1 flex flex-col bg-gray-950">
                        <div className="h-12 border-b border-gray-800 flex items-center px-4 justify-between">
                            <span className="text-sm text-gray-400">Live Preview (Interactive)</span>
                            <div className="flex gap-2">
                                <span className="w-3 h-3 rounded-full bg-red-500">
                                </span>
                                <span className="w-3 h-3 rounded-full bg-yellow-500"></span>
                                <span className="w-3 h-3 rounded-full bg-green-500"></span>
                            </div>
                        </div>
                        <div className="flex-1 p-8 flex justify-center items-center bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
                            {/* Phone Frame */}
                            <div className="w-[375px] h-[667px] bg-black rounded-[3rem] border-8 border-gray-800 shadow-2xl overflow-hidden relative">
                                <iframe 
                                    ref={iframeRef}
                                    title="Preview"
                                    srcDoc={previewUrl}
                                    className="w-full h-full bg-white"
                                />
                            </div>
                        </div>
                        
                        {/* TERMINAL / LOGS */}
                        <div className="h-32 bg-black border-t border-gray-800 font-mono text-xs p-2 overflow-y-auto">
                             {buildLogs.length === 0 && <span className="text-gray-600">Ready to build...</span>}
                             {buildLogs.map((l, i) => <div key={i} className="text-green-400">{l}</div>)}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppBuilder />);
    </script>
</body>
  </html>
  
